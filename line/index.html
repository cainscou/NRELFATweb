<!DOCTYPE html>
<html lang="en-US">
<head>

<meta charset="UTF-8" />
<title>dc test - NREL Line Graph Sample</title>

<meta name="keywords" content="Hydrogen, Fuel Cell, Fuel Cells, National Renewable
    Energy Lab, NREL, U.S. Department of Energy, DOE, Renewable Energy,
	Research, Technology Validation, Charts, Graphs" />
<meta name="description" content="NREL Interactive Web Graphics Template" />
<meta name="author" content="U.S. Department of Energy, National Renewable Energy Lab" />

<!-- Helps compatibility with IE 8 and earlier -->
<!--[if lt IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv.js"></script>
<![endif

<!-- MAIN NREL STYLESHEET -->
<link rel="stylesheet" type="text/css" href="http://www.nrel.gov/includes/nrel.css" />

<link rel="stylesheet" type="text/css" href="dc.css" />

<!-- Local Styles for this WebPage -->
<style>


noscript {
  font-size:150%;
  color:red;
  margin:30px;
}

</style>

</head>  
<body>

<!-- WEBPAGE HTML AND TEXT INFORMATION -->
<!-- Information displayed above the charts -->
<h2>Number of Stations Constructed per year</h2>

<p>This graph represents the number of Hydrogen Fuelling stations constructed across the country</p>

<p><b>Instructions for Interactive Graphics:</b> <br /> <i> Click and drag on the lower graph to select the data range for the upper graph. <br /> This allows you to apply your own custom data filters and criteria!</i></p>

<!-- Additional spacing between text and graph -->
<p> <br /> <br /> </p>

<!-- Added this section in case JavaScript is not enabled on users web browser -->
<noscript><br />Sorry, JavaScript is either not enabled, or is not supported by your web browser.  <br />
		  Scripts must be enabled to see the interactive data visualizations on this page. <hr /> </noscript>
			   
<!-- D3 CHART LOCATION - D3 APPENDS CHART ELEMENTS INTO THIS DIV -->
<div id="lineChart"></div>
<div id="barChart"></div>


<!-- WEBAGE JAVASCRIPTS -->


<!-- Load JQuery - Not currently in use -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script type="text/javascript" src="crossfilter.js"></script>
<script type="text/javascript" src="d3.js"></script>
<script type="text/javascript" src="dc.js"></script>

<!-- Main WebPage Script -->
<script>

// Put graphing script into function call to limit variable scopes.
NRELWebFat_Line();
function NRELWebFat_Line() {

// AJAX CALL FOR DATA DOWNLOAD, AND ADDING DATA INTO THE CHART:
// While the data is downloading, the next block of code after the d3.csv command will 
// execute.  Then, when all data has downloaded, the code inside the function passed 
// as an argument to d3.csv will execute.
d3.csv("cdp8_modifiedHeaders.csv", type, function(error, data) {


  // Defines some error handling if data file can not be loaded.
  if (error) { 
    d3.select("#charts").append("p").append("b")
    .text("The data file to produce interactive graphics could not be loaded."); 
    throw error;
  }
  
  // defines the domain of the data on each chart scale
  x.domain(d3.extent(data.map(function(d) { return d.year; })));
  y.domain([0, d3.max(data.map(function(d) { return d.cost_per_kW_NI; }))]);
  x2.domain(x.domain());
  y2.domain(y.domain());
  
  
	// set up crossfilter
	var crossfilterData = crossfilter(data);
	var all = crossfilterData.groupAll();
	var costPerKwNI = crossfilterData.dimension( function (d) { return d.cost_per_kW_NI; } );
	var year = crossfilterData.dimension( function (d) { return d.year; });
	var yearGroup = year.group();
	var minDate = new Date(2002, 00, 01);
	var maxDate = new Date(2014, 00, 01);
	
	var costPerKwNI_sumByYear = year.group().reduceSum(function (d) { return d.cost_per_kW_NI; } );
	var dataPointsPerYear = year.group().reduceCount();
	var costPerKwIncentive_sumByYear = year.group().reduceSum(function (d) { return d.cost_per_kW_Incentive; } );

	// Set up dc charts
	// var lineComposite = dc.compositeChart("#lineChart");
	var line1 = dc.lineChart("#lineChart")
					.dimension(year)
					.colors('red')
					.group(dataPointsPerYear, "Stations Installed");
	/* var line2 = dc.lineChart(lineComposite)
					.dimension(year)
					.colors('blue')
					.group(costPerKwIncentive_sumByYear, "With Incentive");  */
					
	line1
		.width(width)
		.height(height)
		.x(d3.time.scale().domain([minDate,maxDate]))
		.yAxisLabel("Stations Constructed Per Year")
		.xAxisLabel("Year")
		.legend(dc.legend().x(80).y(20).itemHeight(13).gap(5))
		.renderHorizontalGridLines(true);
	
	var binSize = 500;
	var capacity = crossfilterData.dimension( function (d) { return d.capacity_kW; } );
	var capacityCountByBinsize = capacity.group( function(d) { return d; } );
	
	dc.barChart("#barChart")
		.width(width)
		.height(height)
		.x(d3.scale.linear().domain([0, 5000]))
		.dimension(capacity)
		.group(capacityCountByBinsize)
		//.xUnits(dc.units.fp.precision(binSize))
		.yAxisLabel("Number of Stations Constructed")
		.xAxisLabel("Capacity (kW)");
		
	dc.renderAll();


  // DEFINE EACH LINE TO BE DRAWN ON THE CHART IN THE DATA STRUCTURE BELOW. 
  // Each line is an object in the array. This is in JSON format.
  /*
  Here is a DESCRIPTION of the different items in each line definition object:
	lineDef: This is where you define a d3.svg.line() object. See d3 documentation
			for more information. You need to call the .x and .y methods to define
			the data associated with the line. Use the format in the template as an example.
			Note: .x and .y are passed a function that accesses the data (data is passed
			to the line object later, this just defines what to do with the data when the 
			object is used. Within the function, the variables x and y are not the same as .x and .y.
			x and y refer to the d3 axis scaling objects previously defined.
	textLabel: This is just a text string that will be appended to each line on the chart to label the data.
	yData: This is a vector that specifies the y value data for the line (it is assumed x-value data is the same for
			all lines, so x data is defined in another location.). Some functionality later in the script need
			reference of what the y-data points associated with a line are.
	areaDef: This is where you define a d3.svg.area() object that draws the area curves on the lower subcharts.
			This lower chart is also where brushes are used to filter the graph based on time ranges.
			A similar process is used as in lineDef to define x and y data, except x2 and y2 are used for the d3 axis 
			scaling objects.
	lineColor: Specifies CSS attribute to define the color of the line in the upper chart.
	areaColor: Specifies CSS attribute to define the color of area in the lower chart where the time range can
			be filtered.			
  */	

/*  
  var lines = [

	// #line1 info - No incentives data
	{
	"lineDef": d3.svg.line()
					.x(function(d, i) { return x(yearGroup.all()[i].key); })
					.y(function(d, i) { return y(costPerKwNI_sumByYear[i].value/dataPointsPerYear[i].value); }),
	"yData": year.group().all().map(function(d, i) { return costPerKwNI_sumByYear[i].value/dataPointsPerYear[i].value; }),
	"textLabel": 'No Incentive',
	"lineColor": "steelblue",
	
	"areaDef": d3.svg.area()
					.interpolate("monotone")
					.x(function(d, i) { return x2(yearGroup.all()[i].key); })
					.y0(height2)
					.y1(function(d, i) { return y2(costPerKwNI_sumByYear[i].value/dataPointsPerYear[i].value); }),
	"areaColor": "steelblue"
	},
		
	// #line2 info - With incentives data
	{
	"lineDef": d3.svg.line()
					.x(function(d, i) { return x(yearGroup.all()[i].key); })
					.y(function(d, i) { return y(costPerKwIncentive_sumByYear[i].value/dataPointsPerYear[i].value); }),
					
	"yData": year.group().all().map(function(d, i) 
		{ return costPerKwIncentive_sumByYear[i].value/dataPointsPerYear[i].value; }),
	"textLabel": 'With Incentive',
	"lineColor": "red",
	
	"areaDef": d3.svg.area()
					.interpolate("monotone")
					.x(function(d, i) { return x2(yearGroup.all()[i].key); })
					.y0(height2)
					.y1(function(d, i) { return y2(costPerKwIncentive_sumByYear[i].value/dataPointsPerYear[i].value); }),
	"areaColor": "firebrick"
	}
	
  ];
  */


	  
	  /*
  // Draw the data curve lines into the main upper chart
  d3.select("#focus").selectAll("path")
		.data(lines)
	.enter().append("path")
		.attr("class", "line")
		.attr("id", function(d, i) { return "line" + (i + 1);} )
		.attr("d", function(d) { return d.lineDef(yearGroup.all()); } )
		.attr("style", function(d) { return "stroke: " + d.lineColor + ";" ;})
		.datum(yearGroup.all())
		;
	 */ 



}); // end of d3.csv asynchronous call


// THIS SECTION INITIALIZES VARIABLES THAT DEFINE THE CHART:
// This runs immediately after the data download in d3.csv begins, 
// and before any code within the d3.csv asynchronous call begins.

// Defines chart dimensions
var margin = {top: 10, right: 150, bottom: 135, left: 70},
    margin2 = {top: 430, right: 150, bottom: 60, left: 70},
    width = 750 - margin.left - margin.right,
    height = 400 - margin.top - margin.bottom,
    height2 = 540 - margin2.top - margin2.bottom;

// Defines function to convert timestamps into JavaScript date format
var parseDate = d3.time.format("%Y").parse;

// Define d3 scales for the chart axes.
var x = d3.time.scale(),
    x2 = d3.time.scale().range([0, width]),
    y = d3.scale.linear(),
    y2 = d3.scale.linear().range([height2, 0]);

// Define d3 functions that construct chart axes.
var xAxis = d3.svg.axis().scale(x).orient("bottom"),
    xAxis2 = d3.svg.axis().scale(x2).orient("bottom"),
    yAxis = d3.svg.axis().scale(y).orient("left");
	


// SUB-FUNCTION DEFINITIONS:

// This function executes when data is initially loaded to 
// convert the variable data types from strings.
function type(d) {
  d.year = parseDate(d.year);
  d.cost_per_kW_NI = +d.cost_per_kW_NI;
  d.cost_per_kW_Incentive = +d.cost_per_kW_Incentive;
  return d;
}


}// END OF MAIN WEBPAGE SCRIPT and NRELWebFat_Line Function Call

</script>

</body>
</html>
